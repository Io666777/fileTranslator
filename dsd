package main

import (
	"fmt"
	"log"
	"net/http"
	"text/template"

    "github.com/labstack/echo/v4"

	"gorm.io/driver/postgres"
	"gorm.io/gorm"
)

var DB *gorm.DB  

func InitDB() {
	dsn := "host=localhost user=postgres password=pfft dbname=postgres port=5432 sslmode=disable" // Исправлено posAtgres -> postgres
	var err error

	DB, err = gorm.Open(postgres.Open(dsn), &gorm.Config{})
	if err != nil {
		log.Fatalf("Ошибка подключения БД: %v", err)
	}

	if err := DB.AutoMigrate(&Filestr{}); err != nil {
		log.Fatalf("Не удалось выполнить миграцию: %v", err)  
	}
	
	log.Println("База данных подключена успешно")
}

type Filestr struct {
    ID string `gorm:"primaryKey" json:"id"`
    NAMEFILE string `json:"namefile"`
    AUTHOR string `json:"author"`
    CLOUDKEY string `json:"cloudkey"`
    LANGFROM string `json:"langfrom"`
    LANGTO  string `json:"langto"`

}



func GetFiles(c echo.Context)error{
    var files []Filestr

    if err := DB.Find(&files).Error; err !=nil{
        return  c.JSON(http.StatusInternalServerError, map[string]string{"error": "Не смогли получить файлы"})
    }
    return  c.JSON(http.StatusOK, files)
}



func page(w http.ResponseWriter, r *http.Request) {
    tmpl, err := template.ParseFiles("index.html")
    if err != nil {
        http.Error(w, "Ошибка шаблона", http.StatusInternalServerError)
        return
    }
    tmpl.Execute(w, nil)
}

func HandleRequest() {
    // Обслуживаем статические файлы (CSS, JS, изображения)
    fs := http.FileServer(http.Dir("./web"))
    http.Handle("/web/", http.StripPrefix("/web/", fs))
    
    // HTML страница
    http.HandleFunc("/", page)
    
    fmt.Println("Сервер запущен на http://localhost:5500")
    http.ListenAndServe(":5500", nil)
}


func main() {
	    HandleRequest()
}